const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/wsAgent-BCPQIJLv.js","assets/index-BH-S8nGy.js","assets/index-Om8NWQ_d.css","assets/gameCommands-CeFZJ07i.js"])))=>i.map(i=>d[i]);
import{C as P,r as m,A as w,_ as y}from"./index-BH-S8nGy.js";const L=P("localToken",()=>{const i=m(localStorage.getItem("userToken")||null),s=m(JSON.parse(localStorage.getItem("gameTokens")||"{}")),n=m({}),b=w(()=>!!i.value),$=w(()=>Object.keys(s.value).length>0),v=e=>{i.value=e,localStorage.setItem("userToken",e)},p=()=>{i.value=null,localStorage.removeItem("userToken")},h=(e,t)=>{const r={...t,roleId:e,createdAt:new Date().toISOString(),lastUsed:new Date().toISOString()};return s.value[e]=r,localStorage.setItem("gameTokens",JSON.stringify(s.value)),r},A=e=>{const t=s.value[e];return t&&(t.lastUsed=new Date().toISOString(),localStorage.setItem("gameTokens",JSON.stringify(s.value))),t},d=(e,t)=>{s.value[e]&&(s.value[e]={...s.value[e],...t,updatedAt:new Date().toISOString()},localStorage.setItem("gameTokens",JSON.stringify(s.value)))},O=e=>{delete s.value[e],localStorage.setItem("gameTokens",JSON.stringify(s.value)),n.value[e]&&g(e)},W=()=>{Object.keys(n.value).forEach(e=>{g(e)}),s.value={},localStorage.removeItem("gameTokens")},_=async(e,t,r=null)=>{n.value[e]&&g(e);try{const{WsAgent:o}=await y(async()=>{const{WsAgent:a}=await import("./wsAgent-BCPQIJLv.js");return{WsAgent:a}},__vite__mapDeps([0,1,2])),{gameCommands:c}=await y(async()=>{const{gameCommands:a}=await import("./gameCommands-CeFZJ07i.js");return{gameCommands:a}},__vite__mapDeps([3,1,2]));let l=t;try{const a=t.replace(/^data:.*base64,/,"").trim(),k=atob(a);try{const T=JSON.parse(k);l=T.token||T.gameToken||k}catch{l=k}}catch(a){console.warn("Base64解析失败，使用原始token:",a.message),l=t}const u=new o({heartbeatInterval:2e3,queueInterval:50,channel:"x",autoReconnect:!0,maxReconnectAttempts:5});u.onOpen=()=>{console.log(`✅ WebSocket连接已建立: ${e}`),n.value[e].status="connected",n.value[e].connectedAt=new Date().toISOString(),setTimeout(()=>{u.send(c.role_getroleinfo(0,0,{roleId:e})),u.send(c.system_getdatabundlever())},1e3)},u.onMessage=a=>{console.log(`📨 收到消息 [${e}]:`,a),a.cmd&&E(e,a)},u.onError=a=>{console.error(`❌ WebSocket错误 [${e}]:`,a),n.value[e]&&(n.value[e].status="error",n.value[e].lastError=a.message)},u.onClose=a=>{console.log(`🔌 WebSocket连接已关闭 [${e}]:`,a.code,a.reason),n.value[e]&&(n.value[e].status="disconnected")},u.onReconnect=a=>{console.log(`🔄 WebSocket重连中 [${e}] 第${a}次`),n.value[e]&&(n.value[e].status="reconnecting",n.value[e].reconnectAttempt=a)};const f=r||o.buildUrl("wss://xxz-xyzw.hortorgames.com/agent",{p:l,e:"x",lang:"chinese"});return n.value[e]={agent:u,gameCommands:c,status:"connecting",roleId:e,wsUrl:f,actualToken:l,createdAt:new Date().toISOString(),lastError:null,reconnectAttempt:0},await u.connect(f),u}catch(o){return console.error(`创建WebSocket连接失败 [${e}]:`,o),n.value[e]&&(n.value[e].status="error",n.value[e].lastError=o.message),null}},E=(e,t)=>{const{cmd:r,body:o}=t;switch(r){case"role_getroleinfo":console.log(`角色信息 [${e}]:`,o);break;case"system_getdatabundlever":console.log(`数据包版本 [${e}]:`,o);break;case"task_claimdailyreward":console.log(`每日任务奖励 [${e}]:`,o);break;case"system_signinreward":console.log(`签到奖励 [${e}]:`,o);break;default:console.log(`未处理的消息 [${e}] ${r}:`,o)}},g=e=>{const t=n.value[e];t&&(t.agent&&typeof t.agent.close=="function"?t.agent.close():t.connection&&typeof t.connection.close=="function"&&t.connection.close(),delete n.value[e])},U=e=>{var t;return((t=n.value[e])==null?void 0:t.status)||"disconnected"},C=(e,t,r={})=>{const o=n.value[e];if(!o||!o.agent)return console.warn(`角色 ${e} 的WebSocket连接不存在`),!1;if(o.status!=="connected")return console.warn(`角色 ${e} 的WebSocket未连接`),!1;try{const{gameCommands:c}=o;if(typeof c[t]=="function"){const l=c[t](0,0,r);return o.agent.send(l),console.log(`发送游戏命令 [${e}] ${t}:`,r),!0}else return console.error(`未知的游戏命令: ${t}`),!1}catch(c){return console.error(`发送游戏命令失败 [${e}] ${t}:`,c),!1}},D=async(e,t,r={},o=8e3)=>{const c=n.value[e];if(!c||!c.agent)throw new Error(`角色 ${e} 的WebSocket连接不存在`);if(c.status!=="connected")throw new Error(`角色 ${e} 的WebSocket未连接`);try{const{gameCommands:l}=c;if(typeof l[t]=="function"){const u=await c.agent.sendWithPromise({cmd:t,body:r,timeout:o});return console.log(`游戏命令响应 [${e}] ${t}:`,u),u}else throw new Error(`未知的游戏命令: ${t}`)}catch(l){throw console.error(`发送游戏命令失败 [${e}] ${t}:`,l),l}},x=e=>{const t=n.value[e];return t?{status:t.status,roleId:t.roleId,wsUrl:t.wsUrl,connectedAt:t.connectedAt,createdAt:t.createdAt,lastError:t.lastError,reconnectAttempt:t.reconnectAttempt,agentStatus:t.agent?t.agent.getStatus():null}:{status:"disconnected",roleId:e,error:"连接不存在"}},G=()=>({userToken:i.value,gameTokens:s.value,exportedAt:new Date().toISOString()}),J=e=>{try{return e.userToken&&v(e.userToken),e.gameTokens&&(s.value=e.gameTokens,localStorage.setItem("gameTokens",JSON.stringify(s.value))),{success:!0,message:"Token导入成功"}}catch(t){return console.error("Token导入失败:",t),{success:!1,message:"导入失败：数据格式错误"}}},S=()=>{const e=new Date,t=new Date(e.getTime()-24*60*60*1e3),r={};let o=0;return Object.entries(s.value).forEach(([c,l])=>{new Date(l.lastUsed||l.createdAt)>t?r[c]=l:(o++,n.value[c]&&g(c))}),s.value=r,localStorage.setItem("gameTokens",JSON.stringify(s.value)),o};return{userToken:i,gameTokens:s,wsConnections:n,isUserAuthenticated:b,hasGameTokens:$,setUserToken:v,clearUserToken:p,addGameToken:h,getGameToken:A,updateGameToken:d,removeGameToken:O,clearAllGameTokens:W,createWebSocketConnection:_,closeWebSocketConnection:g,getWebSocketStatus:U,getWebSocketDetails:x,sendGameCommand:C,sendGameCommandWithPromise:D,exportTokens:G,importTokens:J,cleanExpiredTokens:S,initTokenManager:()=>{const e=localStorage.getItem("userToken"),t=localStorage.getItem("gameTokens");if(e&&(i.value=e),t)try{s.value=JSON.parse(t)}catch(r){console.error("解析游戏token数据失败:",r),s.value={}}S()}}});export{L as u};
