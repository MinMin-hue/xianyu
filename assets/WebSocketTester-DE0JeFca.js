import{s as Q,x as X,r as p,A as Y,b as Z,H as ee,c as W,g as a,w as t,i as v,o as i,f as b,m as f,l as o,t as m,a as x,F as te,j as ae,q as le}from"./index-Df_rkx0V.js";import{_ as ne}from"./_plugin-vue_export-helper-DlAUqK2U.js";const se={class:"websocket-tester"},oe={class:"message-log"},re={class:"message-header"},ue={class:"message-content"},ce={key:0,class:"no-messages"},ie={__name:"WebSocketTester",setup(de){const r=Q(),_=X(),n=p(null),d=p("disconnected"),s=p(null),u=p(null),y=p("{}"),T=p(!1),z=p(!1),g=p([]),J=Y(()=>_.gameTokens.map(e=>({label:`${e.name} (${e.server})`,value:e.id}))),R=[{label:"获取角色信息",value:"role_getroleinfo"},{label:"获取数据包版本",value:"system_getdatabundlever"},{label:"签到奖励",value:"system_signinreward"},{label:"领取每日任务奖励",value:"task_claimdailyreward"},{label:"获取邮件列表",value:"mail_getlist"},{label:"领取所有邮件附件",value:"mail_claimallattachment"},{label:"获取军团信息",value:"legion_getinfo"},{label:"英雄招募",value:"hero_recruit"},{label:"领取挂机奖励",value:"system_claimhangupreward"}],O=e=>({connected:"success",connecting:"warning",disconnected:"default",reconnecting:"info",error:"error"})[e]||"default",A=e=>({connected:"已连接",connecting:"连接中",disconnected:"已断开",reconnecting:"重连中",error:"连接错误"})[e]||"未知状态",D=e=>e?new Date(e).toLocaleString("zh-CN"):"-",V=()=>{h()},h=()=>{if(!n.value){d.value="disconnected",s.value=null;return}d.value=_.getWebSocketStatus(n.value);const e=_.wsConnections[n.value];e?s.value={roleId:n.value,status:e.status,connectedAt:e.connectedAt,wsUrl:e.wsUrl}:s.value=null},E=async()=>{if(!n.value){r.error("请先选择Token");return}try{d.value="connecting";const e=_.gameTokens.find(l=>l.id===n.value);if(!e){r.error("未找到Token数据");return}_.createWebSocketConnection(n.value,e.token,e.wsUrl),j(),r.success("WebSocket连接已启动")}catch(e){console.error("WebSocket连接失败:",e),r.error("WebSocket连接失败: "+e.message)}finally{setTimeout(h,1e3)}},P=()=>{n.value&&(_.closeWebSocketConnection(n.value),d.value="disconnected",s.value=null,r.info("WebSocket连接已断开"))},$=async()=>{if(!u.value){r.error("请选择要发送的命令");return}try{T.value=!0;let e={};y.value.trim()&&(e=JSON.parse(y.value)),_.sendMessage(n.value,u.value,e)?(I("sent",{command:u.value,params:e}),r.success("命令发送成功")):r.error("命令发送失败")}catch(e){console.error("发送命令失败:",e),r.error("发送命令失败: "+e.message)}finally{T.value=!1}},F=async()=>{if(!u.value){r.error("请选择要发送的命令");return}try{z.value=!0;let e={};y.value.trim()&&(e=JSON.parse(y.value));const l=await _.sendMessageWithPromise(n.value,u.value,e);I("sent",{command:u.value,params:e}),I("received",l),r.success("命令执行成功，已收到响应")}catch(e){console.error("发送命令失败:",e),r.error("发送命令失败: "+e.message)}finally{z.value=!1}},j=()=>{},I=(e,l)=>{g.value.unshift({type:e,data:l,timestamp:new Date().toISOString()}),g.value.length>100&&(g.value=g.value.slice(0,100))},q=()=>{g.value=[]};let M=null;return Z(()=>{M=setInterval(()=>{n.value&&h()},1e3)}),ee(()=>{M&&clearInterval(M)}),(e,l)=>{const N=v("n-tag"),S=v("n-button"),w=v("n-space"),C=v("n-card"),B=v("n-select"),U=v("n-form-item"),k=v("n-descriptions-item"),L=v("n-text"),H=v("n-descriptions"),G=v("n-input");return i(),W("div",se,[a(C,{title:"WebSocket连接测试",class:"mb-4"},{default:t(()=>[a(w,{direction:"vertical",size:"large"},{default:t(()=>[a(C,{title:"连接状态",size:"small"},{default:t(()=>[a(w,{align:"center"},{default:t(()=>[a(N,{type:O(d.value),size:"large"},{default:t(()=>[o(m(A(d.value)),1)]),_:1},8,["type"]),n.value&&d.value!=="connected"?(i(),b(S,{key:0,type:"primary",loading:d.value==="connecting",onClick:E},{default:t(()=>l[3]||(l[3]=[o(" 连接WebSocket ",-1)])),_:1,__:[3]},8,["loading"])):f("",!0),d.value==="connected"?(i(),b(S,{key:1,type:"error",onClick:P},{default:t(()=>l[4]||(l[4]=[o(" 断开连接 ",-1)])),_:1,__:[4]})):f("",!0)]),_:1})]),_:1}),a(U,{label:"选择角色"},{default:t(()=>[a(B,{value:n.value,"onUpdate:value":[l[0]||(l[0]=c=>n.value=c),V],placeholder:"请选择要测试的角色",options:J.value},null,8,["value","options"])]),_:1}),s.value?(i(),b(C,{key:0,title:"连接详情",size:"small"},{default:t(()=>[a(H,{column:2,bordered:"",size:"small"},{default:t(()=>[a(k,{label:"角色ID"},{default:t(()=>[o(m(s.value.roleId),1)]),_:1}),a(k,{label:"状态"},{default:t(()=>[a(N,{type:O(s.value.status)},{default:t(()=>[o(m(A(s.value.status)),1)]),_:1},8,["type"])]),_:1}),a(k,{label:"WebSocket URL"},{default:t(()=>[a(L,{code:"",style:{"font-size":"12px"}},{default:t(()=>[o(m(s.value.wsUrl),1)]),_:1})]),_:1}),a(k,{label:"连接时间"},{default:t(()=>[o(m(D(s.value.connectedAt)),1)]),_:1}),s.value.lastError?(i(),b(k,{key:0,label:"最后错误"},{default:t(()=>[a(L,{type:"error"},{default:t(()=>[o(m(s.value.lastError),1)]),_:1})]),_:1})):f("",!0),s.value.reconnectAttempt>0?(i(),b(k,{key:1,label:"重连次数"},{default:t(()=>[o(m(s.value.reconnectAttempt),1)]),_:1})):f("",!0)]),_:1})]),_:1})):f("",!0),d.value==="connected"?(i(),b(C,{key:1,title:"游戏命令测试",size:"small"},{default:t(()=>[a(w,{direction:"vertical"},{default:t(()=>[a(U,{label:"选择命令"},{default:t(()=>[a(B,{value:u.value,"onUpdate:value":l[1]||(l[1]=c=>u.value=c),placeholder:"请选择要测试的命令",options:R},null,8,["value"])]),_:1}),u.value?(i(),b(U,{key:0,label:"命令参数 (JSON)"},{default:t(()=>[a(G,{value:y.value,"onUpdate:value":l[2]||(l[2]=c=>y.value=c),type:"textarea",placeholder:'例如: {"roleId": 123456}',rows:3},null,8,["value"])]),_:1})):f("",!0),a(w,null,{default:t(()=>[a(S,{type:"primary",disabled:!u.value,loading:T.value,onClick:$},{default:t(()=>l[5]||(l[5]=[o(" 发送命令 ",-1)])),_:1,__:[5]},8,["disabled","loading"]),a(S,{type:"success",disabled:!u.value,loading:z.value,onClick:F},{default:t(()=>l[6]||(l[6]=[o(" 发送并等待响应 ",-1)])),_:1,__:[6]},8,["disabled","loading"])]),_:1})]),_:1})]),_:1})):f("",!0),a(C,{title:"消息日志",size:"small"},{"header-extra":t(()=>[a(S,{size:"small",onClick:q},{default:t(()=>l[7]||(l[7]=[o(" 清空日志 ",-1)])),_:1,__:[7]})]),default:t(()=>[x("div",oe,[(i(!0),W(te,null,ae(g.value,(c,K)=>(i(),W("div",{key:K,class:le(["message-item",`message-${c.type}`])},[x("div",re,[a(N,{type:c.type==="sent"?"info":"success",size:"small"},{default:t(()=>[o(m(c.type==="sent"?"发送":"接收"),1)]),_:2},1032,["type"]),a(L,{depth:"3",style:{"font-size":"12px"}},{default:t(()=>[o(m(D(c.timestamp)),1)]),_:2},1024)]),x("div",ue,[x("pre",null,m(JSON.stringify(c.data,null,2)),1)])],2))),128)),g.value.length===0?(i(),W("div",ce," 暂无消息日志 ")):f("",!0)])]),_:1})]),_:1})]),_:1})])}}},_e=ne(ie,[["__scopeId","data-v-d0fb8bfd"]]);export{_e as default};
