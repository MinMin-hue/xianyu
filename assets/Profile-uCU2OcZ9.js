import{d as q,c as C,o as U,a as e,s as I,v as K,g as n,w as r,l as m,u as g,N as S,i as w,t as y,F as X,j as Y,z as b,r as Z,y as H,b as D,h as ee}from"./index-DhCM_Bam.js";import{u as te}from"./auth-CGJxvyQf.js";import{u as se}from"./localTokenManager-BPlGUsHA.js";import{u as oe}from"./gameRoles-DQLKevcP.js";import{_ as Q}from"./plugin-vue_export-helper-DlAUqK2U.js";import{R as J}from"./Refresh-Ck0mIM97.js";import{a as ne,E as le,S as re,T as ae,C as ie}from"./TrashBin-D0cGaaw5.js";const ce={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},de=e("rect",{x:"128",y:"128",width:"336",height:"336",rx:"57",ry:"57",fill:"none",stroke:"currentColor","stroke-linejoin":"round","stroke-width":"32"},null,-1),ue=e("path",{d:"M383.5 128l.5-24a56.16 56.16 0 0 0-56-56H112a64.19 64.19 0 0 0-64 64v216a56.16 56.16 0 0 0 56 56h24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32"},null,-1),pe=[de,ue],fe=q({name:"CopyOutline",render:function(l,h){return U(),C("svg",ce,pe)}}),me={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},ke=e("path",{d:"M376 160H272v153.37l52.69-52.68a16 16 0 0 1 22.62 22.62l-80 80a16 16 0 0 1-22.62 0l-80-80a16 16 0 0 1 22.62-22.62L240 313.37V160H136a56.06 56.06 0 0 0-56 56v208a56.06 56.06 0 0 0 56 56h240a56.06 56.06 0 0 0 56-56V216a56.06 56.06 0 0 0-56-56z",fill:"currentColor"},null,-1),ve=e("path",{d:"M272 48a16 16 0 0 0-32 0v112h32z",fill:"currentColor"},null,-1),_e=[ke,ve],ge=q({name:"Download",render:function(l,h){return U(),C("svg",me,_e)}}),we={class:"token-manager"},he={class:"header"},Te={class:"header-actions"},ye={class:"token-section"},be={key:0,class:"token-item"},xe={class:"token-info"},Se={class:"token-value"},Ce={key:1,class:"empty-token"},Ue={class:"token-section"},$e={class:"game-tokens-list"},Pe={class:"token-header"},We={class:"role-info"},Ee={class:"role-name"},Re={class:"role-server"},Oe={class:"token-actions"},Le={class:"token-details"},ze={class:"detail-item"},Ae={class:"detail-value"},je={class:"detail-item"},Me={class:"detail-value"},Ne={class:"detail-item"},Be={class:"detail-value"},Fe={class:"detail-item"},Ge={class:"detail-value"},He={class:"detail-item"},Ve={class:"bulk-actions"},Je={__name:"TokenManager",setup(P){const l=I(),h=K(),d=se(),$=oe(),v=o=>{if(!o)return"";const t=o.length;return t<=8?o:o.substring(0,4)+"***"+o.substring(t-4)},_=o=>new Date(o).toLocaleString("zh-CN"),u=o=>d.getWebSocketStatus(o),W=o=>{switch(o){case"connected":return"success";case"error":return"error";case"connecting":return"warning";default:return"default"}},E=o=>{switch(o){case"connected":return"已连接";case"error":return"连接错误";case"connecting":return"连接中";default:return"未连接"}},R=o=>{const t=[{label:"编辑",key:"edit",icon:()=>b(S,null,{default:()=>b(ie)})},{label:"复制Token",key:"copy",icon:()=>b(S,null,{default:()=>b(fe)})}];return o.importMethod==="url"&&o.sourceUrl?t.unshift({label:"从URL刷新",key:"refresh-url",icon:()=>b(S,null,{default:()=>b(re)})}):t.unshift({label:"刷新Token",key:"refresh",icon:()=>b(S,null,{default:()=>b(J)})}),t.push({type:"divider"},{label:"删除",key:"delete",icon:()=>b(S,null,{default:()=>b(ae)})}),t},O=(o,t,a)=>{switch(o){case"edit":N();break;case"copy":B(a.token);break;case"refresh":j(t);break;case"refresh-url":F(t,a);break;case"delete":M(t);break}},L=()=>{d.initTokenManager(),l.success("Token数据已刷新")},z=()=>{h.warning({title:"清除用户Token",content:"确定要清除用户认证Token吗？这将会退出登录。",positiveText:"确定",negativeText:"取消",onPositiveClick:()=>{d.clearUserToken(),l.success("用户Token已清除")}})},A=(o,t)=>{if(u(o)==="connected")d.closeWebSocketConnection(o),l.info("WebSocket连接已断开");else try{d.createWebSocketConnection(o,t.token,t.wsUrl),l.success("正在建立WebSocket连接...")}catch{l.error("建立WebSocket连接失败")}},j=o=>{const t=d.getGameToken(o);if(!t){l.error("找不到对应的Token数据");return}if(!t.sourceUrl){l.warning("该Token没有配置源地址，无法重新生成。请手动重新导入Token。");return}h.info({title:"重新获取Token",content:"确定要从源地址重新获取此角色的Token吗？",positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{try{const a=l.loading("正在重新获取Token...",{duration:0});let c;const p=t.sourceUrl;if(p.startsWith(window.location.origin)||p.startsWith("/")||p.startsWith("http://localhost")||p.startsWith("http://127.0.0.1"))c=await fetch(p);else try{c=await fetch(p,{method:"GET",headers:{Accept:"application/json"},mode:"cors"})}catch(x){throw new Error(`跨域请求被阻止。请确保目标服务器支持CORS。错误详情: ${x.message}`)}if(!c.ok)throw new Error(`请求失败: ${c.status} ${c.statusText}`);const f=await c.json();if(!f.token)throw new Error("返回数据中未找到token字段");d.updateGameToken(o,{token:f.token,server:f.server||t.server,regeneratedAt:new Date().toISOString(),lastRefreshed:new Date().toISOString()}),d.getWebSocketStatus(o)==="connected"&&(d.closeWebSocketConnection(o),setTimeout(()=>{d.createWebSocketConnection(o,f.token,t.wsUrl)},500)),a.destroy(),l.success("Token已成功重新获取")}catch(a){console.error("重新获取Token失败:",a),l.error(a.message||"Token重新获取失败")}}})},M=o=>{h.warning({title:"删除Token",content:"确定要删除此角色的游戏Token吗？这将断开相关的WebSocket连接。",positiveText:"确定删除",negativeText:"取消",onPositiveClick:()=>{d.removeGameToken(o),l.success("Token已删除")}})},N=(o,t)=>{l.info("编辑功能正在开发中")},B=async o=>{try{await navigator.clipboard.writeText(o),l.success("Token已复制到剪贴板")}catch{const a=document.createElement("textarea");a.value=o,document.body.appendChild(a),a.select(),document.execCommand("copy"),document.body.removeChild(a),l.success("Token已复制到剪贴板")}},F=async(o,t)=>{if(!t.sourceUrl){l.warning("该Token没有配置源URL");return}h.info({title:"从URL刷新Token",content:`确定要从源URL重新获取Token吗？
源地址：${t.sourceUrl}`,positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{try{const a=l.loading("正在从URL获取新Token...",{duration:0});let c;if(t.sourceUrl.startsWith(window.location.origin)||t.sourceUrl.startsWith("/")||t.sourceUrl.startsWith("http://localhost")||t.sourceUrl.startsWith("http://127.0.0.1"))c=await fetch(t.sourceUrl);else{const f=`/api/proxy?url=${encodeURIComponent(t.sourceUrl)}`;c=await fetch(f)}if(!c.ok)throw new Error(`HTTP ${c.status}: ${c.statusText}`);const i=await c.json();if(!i.token)throw new Error("返回数据中未找到token字段");d.updateGameToken(o,{token:i.token,lastUsed:new Date().toISOString()}),a.destroy(),l.success("Token刷新成功")}catch(a){console.error("URL刷新Token失败:",a),l.error("刷新失败: "+a.message)}}})},k=()=>{try{const o=d.exportTokens(),t=JSON.stringify(o,null,2),a=new Blob([t],{type:"application/json"}),c=document.createElement("a");c.href=URL.createObjectURL(a),c.download=`tokens_backup_${new Date().toISOString().split("T")[0]}.json`,c.click(),l.success("Token数据已导出")}catch(o){l.error("导出失败: "+o.message)}},s=({file:o})=>{const t=new FileReader;t.onload=a=>{try{const c=JSON.parse(a.target.result),p=d.importTokens(c);p.success?(l.success(p.message),$.fetchGameRoles()):l.error(p.message)}catch{l.error("导入失败：文件格式错误")}},t.readAsText(o.file)},G=()=>{h.info({title:"清理过期Token",content:"确定要清理超过24小时未使用的Token吗？",positiveText:"确定",negativeText:"取消",onPositiveClick:()=>{const o=d.cleanExpiredTokens();l.success(`已清理 ${o} 个过期Token`)}})},T=()=>{h.error({title:"清除所有Token",content:"确定要清除所有游戏Token吗？这将断开所有WebSocket连接。此操作不可恢复！",positiveText:"确定清除",negativeText:"取消",onPositiveClick:()=>{d.clearAllGameTokens(),l.success("所有游戏Token已清除")}})};return(o,t)=>{const a=w("n-button"),c=w("n-upload"),p=w("n-dropdown"),i=w("n-tag");return U(),C("div",we,[e("div",he,[t[3]||(t[3]=e("h3",null,"Token管理器",-1)),e("div",Te,[n(a,{size:"small",onClick:L},{icon:r(()=>[n(g(S),null,{default:r(()=>[n(g(J))]),_:1})]),default:r(()=>[t[0]||(t[0]=m(" 刷新 ",-1))]),_:1,__:[0]}),n(a,{size:"small",type:"warning",onClick:k},{icon:r(()=>[n(g(S),null,{default:r(()=>[n(g(ge))]),_:1})]),default:r(()=>[t[1]||(t[1]=m(" 导出 ",-1))]),_:1,__:[1]}),n(c,{"show-file-list":!1,accept:".json",onChange:s},{default:r(()=>[n(a,{size:"small",type:"info"},{icon:r(()=>[n(g(S),null,{default:r(()=>[n(g(ne))]),_:1})]),default:r(()=>[t[2]||(t[2]=m(" 导入 ",-1))]),_:1,__:[2]})]),_:1})])]),e("div",ye,[t[7]||(t[7]=e("h4",null,"用户认证Token",-1)),g(d).userToken?(U(),C("div",be,[e("div",xe,[t[4]||(t[4]=e("span",{class:"token-label"},"Token:",-1)),e("span",Se,y(v(g(d).userToken)),1)]),n(a,{size:"tiny",type:"error",onClick:z},{default:r(()=>t[5]||(t[5]=[m(" 清除 ",-1)])),_:1,__:[5]})])):(U(),C("div",Ce,t[6]||(t[6]=[e("span",null,"未设置用户Token",-1)])))]),e("div",Ue,[e("h4",null,"游戏角色Token ("+y(Object.keys(g(d).gameTokens).length)+"个)",1),e("div",$e,[(U(!0),C(X,null,Y(g(d).gameTokens,(f,x)=>(U(),C("div",{key:x,class:"game-token-item"},[e("div",Pe,[e("div",We,[e("span",Ee,y(f.roleName),1),e("span",Re,y(f.server),1)]),e("div",Oe,[n(a,{size:"tiny",type:u(x)==="connected"?"success":"default",onClick:V=>A(x,f)},{default:r(()=>[m(y(u(x)==="connected"?"断开WS":"连接WS"),1)]),_:2},1032,["type","onClick"]),n(p,{options:R(f),trigger:"click",onSelect:V=>O(V,x,f)},{default:r(()=>[n(a,{size:"tiny",type:"tertiary"},{icon:r(()=>[n(g(S),null,{default:r(()=>[n(g(le))]),_:1})]),_:1})]),_:2},1032,["options","onSelect"])])]),e("div",Le,[e("div",ze,[t[8]||(t[8]=e("span",{class:"detail-label"},"Token:",-1)),e("span",Ae,y(v(f.token)),1)]),e("div",je,[t[9]||(t[9]=e("span",{class:"detail-label"},"WebSocket URL:",-1)),e("span",Me,y(f.wsUrl),1)]),e("div",Ne,[t[10]||(t[10]=e("span",{class:"detail-label"},"创建时间:",-1)),e("span",Be,y(_(f.createdAt)),1)]),e("div",Fe,[t[11]||(t[11]=e("span",{class:"detail-label"},"最后使用:",-1)),e("span",Ge,y(_(f.lastUsed)),1)]),e("div",He,[t[12]||(t[12]=e("span",{class:"detail-label"},"连接状态:",-1)),n(i,{size:"small",type:W(u(x))},{default:r(()=>[m(y(E(u(x))),1)]),_:2},1032,["type"])])])]))),128))])]),e("div",Ve,[n(a,{type:"warning",onClick:G},{default:r(()=>t[13]||(t[13]=[m(" 清理过期Token ",-1)])),_:1,__:[13]}),n(a,{type:"error",onClick:T},{default:r(()=>t[14]||(t[14]=[m(" 清除所有Token ",-1)])),_:1,__:[14]})])])}}},qe=Q(Je,[["__scopeId","data-v-00b2f2ae"]]),Ie={class:"profile-page"},Ke={class:"container"},Qe={class:"profile-content"},Xe={class:"profile-section"},Ye={class:"info-card"},Ze={class:"avatar-section"},De={class:"info-form"},et={class:"form-actions"},tt={class:"profile-section"},st={class:"info-card"},ot={class:"form-actions"},nt={class:"profile-section"},lt={class:"info-card"},rt={class:"preferences-grid"},at={class:"preference-item"},it={class:"preference-item"},ct={class:"preference-item"},dt={class:"preference-item"},ut={class:"form-actions"},pt={class:"profile-section"},ft={class:"profile-section"},mt={class:"info-card"},kt={class:"security-items"},vt={class:"security-item"},_t={class:"security-item"},gt={class:"security-item"},wt={class:"security-item danger"},ht={__name:"Profile",setup(P){ee();const l=I(),h=K(),d=te(),$=Z(null),v=H({username:"",email:"",nickname:"",phone:"",avatar:""}),_=H({currentPassword:"",newPassword:"",confirmPassword:""}),u=H({theme:"auto",language:"zh-CN",notifications:!0,autoExecute:!1}),W={currentPassword:[{required:!0,message:"请输入当前密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度不能少于6位",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认新密码",trigger:"blur"},{validator:(k,s)=>s===_.newPassword,message:"两次输入的密码不一致",trigger:"blur"}]},E=[{label:"跟随系统",value:"auto"},{label:"浅色主题",value:"light"},{label:"深色主题",value:"dark"}],R=[{label:"简体中文",value:"zh-CN"},{label:"English",value:"en-US"}],O=async()=>{try{l.success("个人信息保存成功")}catch{l.error("保存失败，请稍后重试")}},L=async()=>{if($.value)try{await $.value.validate(),l.success("密码修改成功"),Object.keys(_).forEach(k=>{_[k]=""})}catch{}},z=()=>{localStorage.setItem("userPreferences",JSON.stringify(u)),l.success("偏好设置保存成功")},A=k=>{u.theme=k,localStorage.setItem("theme",k),k==="dark"?document.documentElement.setAttribute("data-theme","dark"):k==="light"?document.documentElement.removeAttribute("data-theme"):window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.setAttribute("data-theme","dark"):document.documentElement.removeAttribute("data-theme")},j=()=>{l.info("头像更换功能开发中...")},M=()=>{l.info("两步验证设置功能开发中...")},N=()=>{l.info("登录历史查看功能开发中...")},B=()=>{l.info("数据导出功能开发中...")},F=()=>{h.warning({title:"删除账户",content:"此操作将永久删除您的账户和所有数据，且无法恢复。确定要继续吗？",positiveText:"确定删除",negativeText:"取消",onPositiveClick:()=>{l.error("账户删除功能暂未开放")}})};return D(()=>{d.userInfo&&Object.assign(v,d.userInfo);const k=localStorage.getItem("userPreferences");if(k)try{Object.assign(u,JSON.parse(k))}catch(s){console.error("解析用户偏好失败:",s)}}),(k,s)=>{const G=w("n-avatar"),T=w("n-button"),o=w("n-input"),t=w("n-form-item"),a=w("n-form"),c=w("n-select"),p=w("n-switch");return U(),C("div",Ie,[e("div",Ke,[s[32]||(s[32]=e("div",{class:"page-header"},[e("h1",null,"个人资料"),e("p",null,"管理您的账户信息和偏好设置")],-1)),e("div",Qe,[e("div",Xe,[s[13]||(s[13]=e("h2",null,"基本信息",-1)),e("div",Ye,[e("div",Ze,[n(G,{size:"large",src:v.avatar,"fallback-src":"/icons/xiaoyugan.png"},null,8,["src"]),n(T,{size:"small",onClick:j},{default:r(()=>s[11]||(s[11]=[m(" 更换头像 ",-1)])),_:1,__:[11]})]),e("div",De,[n(a,{model:v,"label-placement":"left","label-width":"80px"},{default:r(()=>[n(t,{label:"用户名"},{default:r(()=>[n(o,{value:v.username,"onUpdate:value":s[0]||(s[0]=i=>v.username=i),readonly:""},null,8,["value"])]),_:1}),n(t,{label:"邮箱"},{default:r(()=>[n(o,{value:v.email,"onUpdate:value":s[1]||(s[1]=i=>v.email=i)},null,8,["value"])]),_:1}),n(t,{label:"昵称"},{default:r(()=>[n(o,{value:v.nickname,"onUpdate:value":s[2]||(s[2]=i=>v.nickname=i),placeholder:"请输入昵称"},null,8,["value"])]),_:1}),n(t,{label:"手机"},{default:r(()=>[n(o,{value:v.phone,"onUpdate:value":s[3]||(s[3]=i=>v.phone=i),placeholder:"请输入手机号"},null,8,["value"])]),_:1})]),_:1},8,["model"]),e("div",et,[n(T,{type:"primary",onClick:O},{default:r(()=>s[12]||(s[12]=[m(" 保存更改 ",-1)])),_:1,__:[12]})])])])]),e("div",tt,[s[15]||(s[15]=e("h2",null,"密码修改",-1)),e("div",st,[n(a,{ref_key:"passwordFormRef",ref:$,model:_,rules:W,"label-placement":"left","label-width":"100px"},{default:r(()=>[n(t,{label:"当前密码",path:"currentPassword"},{default:r(()=>[n(o,{value:_.currentPassword,"onUpdate:value":s[4]||(s[4]=i=>_.currentPassword=i),type:"password",placeholder:"请输入当前密码"},null,8,["value"])]),_:1}),n(t,{label:"新密码",path:"newPassword"},{default:r(()=>[n(o,{value:_.newPassword,"onUpdate:value":s[5]||(s[5]=i=>_.newPassword=i),type:"password",placeholder:"请输入新密码"},null,8,["value"])]),_:1}),n(t,{label:"确认新密码",path:"confirmPassword"},{default:r(()=>[n(o,{value:_.confirmPassword,"onUpdate:value":s[6]||(s[6]=i=>_.confirmPassword=i),type:"password",placeholder:"请再次输入新密码"},null,8,["value"])]),_:1})]),_:1},8,["model"]),e("div",ot,[n(T,{type:"primary",onClick:L},{default:r(()=>s[14]||(s[14]=[m(" 修改密码 ",-1)])),_:1,__:[14]})])])]),e("div",nt,[s[21]||(s[21]=e("h2",null,"系统偏好",-1)),e("div",lt,[e("div",rt,[e("div",at,[s[16]||(s[16]=e("div",{class:"preference-label"},[e("h3",null,"主题设置"),e("p",null,"选择您喜欢的界面主题")],-1)),n(c,{value:u.theme,"onUpdate:value":[s[7]||(s[7]=i=>u.theme=i),A],options:E},null,8,["value"])]),e("div",it,[s[17]||(s[17]=e("div",{class:"preference-label"},[e("h3",null,"语言设置"),e("p",null,"选择界面显示语言")],-1)),n(c,{value:u.language,"onUpdate:value":s[8]||(s[8]=i=>u.language=i),options:R},null,8,["value"])]),e("div",ct,[s[18]||(s[18]=e("div",{class:"preference-label"},[e("h3",null,"通知设置"),e("p",null,"接收任务完成通知")],-1)),n(p,{value:u.notifications,"onUpdate:value":s[9]||(s[9]=i=>u.notifications=i)},null,8,["value"])]),e("div",dt,[s[19]||(s[19]=e("div",{class:"preference-label"},[e("h3",null,"自动执行"),e("p",null,"默认开启任务自动执行")],-1)),n(p,{value:u.autoExecute,"onUpdate:value":s[10]||(s[10]=i=>u.autoExecute=i)},null,8,["value"])])]),e("div",ut,[n(T,{type:"primary",onClick:z},{default:r(()=>s[20]||(s[20]=[m(" 保存偏好 ",-1)])),_:1,__:[20]})])])]),e("div",pt,[s[22]||(s[22]=e("h2",null,"Token管理",-1)),n(qe)]),e("div",ft,[s[31]||(s[31]=e("h2",null,"账户安全",-1)),e("div",mt,[e("div",kt,[e("div",vt,[s[24]||(s[24]=e("div",{class:"security-info"},[e("h3",null,"两步验证"),e("p",null,"为您的账户添加额外的安全保护")],-1)),n(T,{onClick:M},{default:r(()=>s[23]||(s[23]=[m(" 设置 ",-1)])),_:1,__:[23]})]),e("div",_t,[s[26]||(s[26]=e("div",{class:"security-info"},[e("h3",null,"登录历史"),e("p",null,"查看最近的登录记录")],-1)),n(T,{onClick:N},{default:r(()=>s[25]||(s[25]=[m(" 查看 ",-1)])),_:1,__:[25]})]),e("div",gt,[s[28]||(s[28]=e("div",{class:"security-info"},[e("h3",null,"数据导出"),e("p",null,"导出您的所有数据")],-1)),n(T,{onClick:B},{default:r(()=>s[27]||(s[27]=[m(" 导出 ",-1)])),_:1,__:[27]})]),e("div",wt,[s[30]||(s[30]=e("div",{class:"security-info"},[e("h3",null,"删除账户"),e("p",null,"永久删除您的账户和所有数据")],-1)),n(T,{type:"error",onClick:F},{default:r(()=>s[29]||(s[29]=[m(" 删除 ",-1)])),_:1,__:[29]})])])])])])])])}}},$t=Q(ht,[["__scopeId","data-v-e8c934f5"]]);export{$t as default};
