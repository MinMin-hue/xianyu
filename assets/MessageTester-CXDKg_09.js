import{x as h,s as q,r as C,A as b,D as E,c as y,g as n,w as a,i,o as m,a as u,m as M,f as $,l as r,t as k,F as K,j as P,q as Q}from"./index-Df_rkx0V.js";import{u as X}from"./gameRoles-C7JwkeX0.js";import{_ as Y}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./localTokenManager-Cym2SbJC.js";const Z={class:"message-tester"},ee={class:"space-y-4"},se={key:0},te={class:"grid grid-cols-2 gap-2"},ne={class:"space-y-2"},ae={class:"message-history max-h-96 overflow-y-auto"},le={class:"flex justify-between items-center mb-2"},oe={class:"font-semibold"},re={class:"text-sm text-gray-500 ml-2"},ue={key:0,class:"text-sm"},ce={class:"mt-2"},de={class:"text-xs bg-gray-100 p-2 rounded overflow-x-auto"},ie={key:0,class:"text-center text-gray-500"},ve={__name:"MessageTester",setup(me){const v=h(),T=X(),l=q(),t=C(null),d=C(""),w=C("{}"),_=C([]),O=b(()=>T.gameRoles.map(s=>({label:s.name,value:s.id}))),S=b(()=>t.value?v.getWebSocketStatus(t.value):"disconnected"),R=b(()=>{switch(S.value){case"connected":return"success";case"connecting":return"warning";case"error":return"error";default:return"default"}}),I=b(()=>{switch(S.value){case"connected":return"🟢 已连接";case"connecting":return"🟡 连接中";case"error":return"🔴 连接错误";default:return"⚪ 未连接"}}),c=b(()=>t.value&&S.value==="connected"),V=()=>{if(!t.value)return;const s=T.gameRoles.find(e=>e.id===t.value);s&&(T.selectRole(s),l.success("正在建立WebSocket连接..."))},p=(s,e,f=null)=>{_.value.unshift({type:s,timestamp:new Date().toISOString(),cmd:f,data:e}),_.value.length>50&&(_.value=_.value.slice(0,50))},B=()=>{if(!c.value)return;v.sendHeartbeat(t.value)?(p("sent",{cmd:"_sys/ack"},"_sys/ack"),l.success("心跳消息已发送")):l.error("心跳消息发送失败")},D=()=>{if(!c.value)return;v.sendGetRoleInfo(t.value)?(p("sent",{cmd:"role_getroleinfo"},"role_getroleinfo"),l.success("角色信息请求已发送")):l.error("角色信息请求发送失败")},J=()=>{if(!c.value)return;v.sendGameMessage(t.value,"system_getdatabundlever",{isAudit:!1})?(p("sent",{cmd:"system_getdatabundlever"},"system_getdatabundlever"),l.success("数据版本请求已发送")):l.error("数据版本请求发送失败")},H=()=>{if(!c.value)return;v.sendGameMessage(t.value,"system_signinreward",{})?(p("sent",{cmd:"system_signinreward"},"system_signinreward"),l.success("签到请求已发送")):l.error("签到请求发送失败")},W=()=>{if(!(!c.value||!d.value))try{const s=JSON.parse(w.value||"{}");v.sendGameMessage(t.value,d.value,s)?(p("sent",{cmd:d.value,body:s},d.value),l.success(`自定义消息 ${d.value} 已发送`),d.value="",w.value="{}"):l.error("自定义消息发送失败")}catch(s){l.error("消息体JSON格式错误: "+s.message)}},U=s=>new Date(s).toLocaleTimeString(),j=s=>JSON.stringify(s,null,2);return E(()=>v.wsConnections,s=>{var f;if(!t.value||!s[t.value])return;const e=s[t.value];if(e.lastMessage){const x=e.lastMessage;p("received",x.parsed,(f=x.parsed)==null?void 0:f.cmd)}},{deep:!0}),(s,e)=>{const f=i("n-select"),x=i("n-tag"),g=i("n-button"),N=i("n-divider"),G=i("n-input"),z=i("n-collapse-item"),A=i("n-collapse"),F=i("n-card");return m(),y("div",Z,[n(F,{title:"消息加解密测试",class:"mb-4"},{default:a(()=>[u("div",ee,[u("div",null,[n(f,{value:t.value,"onUpdate:value":e[0]||(e[0]=o=>t.value=o),options:O.value,placeholder:"选择要测试的Token",class:"w-full"},null,8,["value","options"])]),t.value?(m(),y("div",se,[n(x,{type:R.value},{default:a(()=>[r(k(I.value),1)]),_:1},8,["type"]),S.value!=="connected"?(m(),$(g,{key:0,type:"primary",size:"small",class:"ml-2",onClick:V},{default:a(()=>e[3]||(e[3]=[r(" 连接WebSocket ",-1)])),_:1,__:[3]})):M("",!0)])):M("",!0),n(N,{"title-placement":"left"},{default:a(()=>e[4]||(e[4]=[r(" 预设消息测试 ",-1)])),_:1,__:[4]}),u("div",te,[n(g,{disabled:!c.value,onClick:B},{default:a(()=>e[5]||(e[5]=[r(" 💗 发送心跳 ",-1)])),_:1,__:[5]},8,["disabled"]),n(g,{disabled:!c.value,onClick:D},{default:a(()=>e[6]||(e[6]=[r(" 👤 获取角色信息 ",-1)])),_:1,__:[6]},8,["disabled"]),n(g,{disabled:!c.value,onClick:J},{default:a(()=>e[7]||(e[7]=[r(" 📦 获取数据版本 ",-1)])),_:1,__:[7]},8,["disabled"]),n(g,{disabled:!c.value,onClick:H},{default:a(()=>e[8]||(e[8]=[r(" 📅 签到 ",-1)])),_:1,__:[8]},8,["disabled"])]),n(N,{"title-placement":"left"},{default:a(()=>e[9]||(e[9]=[r(" 自定义消息 ",-1)])),_:1,__:[9]}),u("div",ne,[n(G,{value:d.value,"onUpdate:value":e[1]||(e[1]=o=>d.value=o),placeholder:"命令 (例如: role_getroleinfo)",class:"w-full"},null,8,["value"]),n(G,{value:w.value,"onUpdate:value":e[2]||(e[2]=o=>w.value=o),type:"textarea",placeholder:'消息体 JSON (例如: {"clientVersion": "1.65.3-wx"})',rows:3,class:"w-full"},null,8,["value"]),n(g,{disabled:!c.value||!d.value,type:"primary",onClick:W},{default:a(()=>e[10]||(e[10]=[r(" 🚀 发送自定义消息 ",-1)])),_:1,__:[10]},8,["disabled"])]),n(N,{"title-placement":"left"},{default:a(()=>e[11]||(e[11]=[r(" 消息历史 ",-1)])),_:1,__:[11]}),u("div",ae,[(m(!0),y(K,null,P(_.value,(o,L)=>(m(),y("div",{key:L,class:Q(["message-item p-3 mb-2 rounded border",o.type==="sent"?"bg-blue-50 border-blue-200":"bg-green-50 border-green-200"])},[u("div",le,[u("span",oe,[r(k(o.type==="sent"?"📤 发送":"📨 接收")+" ",1),u("span",re,k(U(o.timestamp)),1)])]),o.cmd?(m(),y("div",ue,[e[12]||(e[12]=u("strong",null,"命令:",-1)),r(" "+k(o.cmd),1)])):M("",!0),u("div",ce,[n(A,null,{default:a(()=>[n(z,{title:"查看详细数据",name:"detail"},{default:a(()=>[u("pre",de,k(j(o.data)),1)]),_:2},1024)]),_:2},1024)])],2))),128)),_.value.length===0?(m(),y("div",ie," 暂无消息历史 ")):M("",!0)])])]),_:1})])}}},ye=Y(ve,[["__scopeId","data-v-84c512d9"]]);export{ye as default};
